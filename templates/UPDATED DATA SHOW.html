<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ page_name }}e</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
    

    <script 
    
    type="text/javascript"
    src="{{ url_for('static',filename='cytoscape.min.js')}}"></script>
    <script src="https://unpkg.com/webcola/WebCola/cola.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bluebird/3.5.2/bluebird.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fetch/2.0.3/fetch.min.js"></script>
    <script src="https://unpkg.com/weaverjs@1.2.0/dist/weaver.min.js"></script>


    <script src="https://cdnjs.cloudflare.com/ajax/libs/core-js/2.5.7/shim.min.js"></script>
    <script src="https://unpkg.com/layout-base/layout-base.js"></script>
    <script src="https://unpkg.com/cose-base/cose-base.js"></script>


    <script 
    type="text/javascript"
    src="{{ url_for('static',filename='cytoscape-cola.js')}}"></script>
    <script 
    type="text/javascript"
    src="{{ url_for('static',filename='cytoscape-cose-bilkent.js')}}"></script>
    
    <script 
    type="text/javascript"
    src="{{ url_for('static',filename='cytoscape-spread.js')}}"></script>
    <style>
        #cy {
            width: 70%;
            height: 100%;
            position: absolute;
            top: 0px;
            left: 0px;
            
        }
        #demo{
            margin-left: 70%;
            margin-top: 10px;
            width: 29%;
            height: 100px;
        }
        #table{
            margin-left: 70%;
            margin-top: 100px;
            width: 28%;
            height: 40%;
        }
        
    </style>
</head>
<body>
    <div id="cy"></div>
    <div style="margin-left: 70%;">
        <center>
        <p style="margin-bottom: -10px;">Powered by</p>
        <img src="{{ url_for('static',filename='Xploit-removebg-preview.png')}}" alt="" style="margin-top: -200px;margin-bottom: -190px;">
    </center>
    </div>
    
    
    <!-- <a href="{{ redirection }}"><button class="btn btn-primary" style="margin-left: 70%;margin-top:2px">Generated by XPLOIT MAP{{ button_name }}</button></a> -->
    <table class="table" id="table" style="font-size: 20px;margin-top: 150px;">
        <thead>
            <tr >
                <th scope="col">CVE ID</th>
                <th id = "cve_id">Click on node</th>
            </tr>
        </thead>
        <tbody>
            <tr >
                <th scope="col">CWE ID</th>
                <th scope="row" id="cwe_id" >click on node</th>
            </tr>
        </tbody>
        <tbody>
            <tr>
                <th>CVSS</th>
                <th id = "cvss_data">Click on node</th>
            </tr>
        </tbody>
        <tbody>
            <tr>
                <th>MITRE ATT&CK ID</th>
                <th id = "mitre_attack_id">Click on node</th>
            </tr>
        </tbody>
        <tbody>
            <tr>
                <th colspan="2" style="text-align: center;">MITRE D3FEND ID</th>
            </tr>
        </tbody>
        <tbody>
            <tr>
                <th>HARDEN</th>
                <th id = "harden_data">Click on node</th>
            </tr>
        </tbody>
        <tbody>
            <tr>
                <th>DETECT</th>
                <th id="detect_data">Click on node</th>
            </tr>
        </tbody>
    </table>
    
    <!-- <h1 id='demo'>Something</h1> -->
    <script>
        const data = '{{nodes | tojson}}';
        console.log(data);
        console.log(typeof data);
        console.log(JSON.parse(data));
        var cy = cytoscape({
        container: document.getElementById('cy'),
        elements: JSON.parse(data),
            style: [
                {
                    "selector": 'node',
                    "css": {
                        'shape': 'round',
                        'background-color': 'red',
                        "font-family" : "SansSerif.plain",
                        "font-weight" : "normal",
                        // "text-wrap" :"wrap",
                        // "text-max-width": 100,
                        "text-overflow-wrap":"break-world",
                        "text-border-width" : 10,
                        "text-valign" : "center",
                        "text-halign" : "center",
                        "text-opacity" : 1.0,
                        "font-size" : 30,
                        "content" : "data(name)",
                        "width" : 100,
                        'height': 100,
                    }
                },
                {
                    "selector" : ":parent",
                    "css" : {
                        'text-valign': 'top',
                        'text-halign': 'center',
                        'background-color':'grey'
                    },
                },
                {
                    "selector" : "node:selected",
                    "css" : {
                        // "background-color" : "rgb(255,255,0)",
                        // "font-weight":"bold",
                        "border-width": "10px",
                        "border-color": "rgb(0,0,0)",
                        "border-opacity": "0.2",
                        "background-color": "#77828C",
                        "text-outline-width":"2px",
                        "text-outline-color": "#77828C"
                    }

                },
                {
                    "selector" : "edge[directed = 'true']",
                    "css" : {
                        'width': 6,
                        'curve-style': 'bezier',
                        'target-arrow-shape': 'triangle'
                        
                    },
                },
                ]
                
        });
        var layout = cy.layout({
            name: '{{ layout }}',
            roots: "{{ root_node }}",
            animate : true,
            animationEasing: 'ease-out',
            animationDuration: 1000,
            flow : { axis: 'y', minSeparation: 30 },
            avoidOverlap : true,
            
        });

        // data which will be shown when clicked on node
        // cve_id , cwe_id, cvss_data, mitre_attack_id, harden_data, detect_data
        cy.on('tap', 'node', function (evt) {
            for (let x in evt.target.data()) {
                console.log(x);
            }
            console.log(evt.target.data());
            document.getElementById("cve_id").innerHTML = evt.target.data('cve_id');
            document.getElementById("cwe_id").innerHTML = evt.target.data('cwe_id');
            document.getElementById("cvss_data").innerHTML = evt.target.data('cvss_data');
            document.getElementById("mitre_attack_id").innerHTML = evt.target.data('mitre_attack_id');
            document.getElementById("harden_data").innerHTML = evt.target.data('harden_data');
            document.getElementById("detect_data").innerHTML = evt.target.data('detect_data');
            console.log(evt.target.data('information'));
       });
       
       cy.on('tap', 'edge', function (evt) {
        document.getElementById("demo").innerHTML = evt.target.data('description');
        document.getElementById("nameofnode").innerHTML = evt.target.data('id');
        document.getElementById("CWE_id").innerHTML = evt.target.data('cwe_id');
        document.getElementById("SCORE").innerHTML = evt.target.data('cve_score');



        console.log(evt.target.data('information'))
        });

        //if clicked which data will be changed
        // cy.nodes().on('click', function(evt){
        //     var node = evt.target;
        //     node.style('background-color', 'red');
        // });
        
        
        // when unsleected which data will be changed
        // cy.on('unselect', 'node', function(evt){
        //     var node = evt.target;
        //     node.style('background-color', node.data('color'));
        // });
        
        layout.run();
    </script>
</body>
</html>